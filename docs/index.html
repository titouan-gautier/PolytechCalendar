<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Calendrier Filtre</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css"
      rel="stylesheet"
    />
    <style>
      :root {
        --fc-small-font-size: 0.85em;
        --fc-page-bg-color: #fff;
      }

      body {
        margin: 1em;
        font-family: Arial, sans-serif;
        line-height: 1.5;
      }

      h1 {
        font-size: 1.6em;
        text-align: center;
        margin: 0.5em 0;
      }

      #calendar {
        max-width: 100%;
        margin: 0 auto;
      }

      /* Adaptation mobile */
      @media (max-width: 768px) {
        body {
          margin: 0.5em;
        }

        .fc-toolbar {
          flex-direction: column;
          gap: 0.5em;
        }

        .fc-toolbar-title {
          font-size: 1.2em;
          order: -1;
        }

        .fc-button-group {
          flex-wrap: wrap;
          gap: 0.3em;
        }

        .fc-button {
          padding: 0.3em 0.6em;
          font-size: 0.9em;
        }

        .fc-timeGridWeek-button,
        .fc-dayGridMonth-button {
          display: none;
        }

        .fc-event {
          font-size: 0.8em;
          padding: 2px;
        }
      }

      /* Ajoutez ceci dans votre balise <style> */
      .fc-event {
        overflow: hidden; /* Emp√™che le d√©bordement du contenu */
        cursor: pointer;
        transition: opacity 0.2s;
      }

      .fc-event-main {
        display: flex;
        flex-direction: column;
        padding: 2px;
        height: 100%; /* Utilise toute la hauteur disponible */
      }

      .event-location {
        font-size: 0.8em;
        opacity: 0.9;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis; /* Ajoute des points de suspension si le texte est trop long */
        margin-top: 2px;
      }

      /* Pour les √©v√©nements courts */
      .fc-timegrid-event .fc-event-main {
        padding: 1px;
        min-height: 25px;
      }

      .fc-event:hover {
        opacity: 0.8;
      }
    </style>
  </head>
  <body>
    <div id="calendar"></div>
    <button id="refreshButton">Refresh</button>
    <p id="statusMessage"></p>

    <script src="https://cdn.jsdelivr.net/npm/ical.js@1.4.0/build/ical.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/icalendar@5.11.3/main.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/fr.min.js"></script>

    <script>
      // Fonction pour d√©clencher le workflow
      async function triggerWorkflow() {
        const button = document.getElementById("refreshButton");
        const status = document.getElementById("statusMessage");

        const part1 = "ghp_LSWZ6g7gp";
        const part2 = "A9K3ziJb7e2o";
        const part3 = "NFqCqd50R0q8gCF";

        try {
          button.disabled = true;
          status.textContent = "Rafra√Æchissement en cours...";

          const response = await fetch(
            `https://api.github.com/repos/titouan-gautier/PolytechCalendar/actions/workflows/update_calendar.yml/dispatches`,
            {
              method: "POST",
              headers: {
                Accept: "application/vnd.github+json",
                Authorization: `Bearer ${part1 + part2 + part3}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                ref: "main", // Branche √† cibler
              }),
            }
          );

          if (response.ok) {
            status.textContent =
              "Rafra√Æchissement d√©clench√© ! Le calendrier sera mis √† jour dans quelques minutes.";
            setTimeout(() => {
              window.location.reload();
            }, 120000); // Recharger apr√®s 2 minutes
          } else {
            throw new Error("Erreur lors du d√©clenchement");
          }
        } catch (error) {
          status.textContent = "Erreur : " + error.message;
          console.error(error);
        } finally {
          button.disabled = false;
        }
      }

      // Ajout du gestionnaire d'√©v√©nement
      document
        .getElementById("refreshButton")
        .addEventListener("click", triggerWorkflow);
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const calendarEl = document.getElementById("calendar");
        const isMobile = window.matchMedia("(max-width: 768px)").matches;

        const calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: isMobile ? "timeGridDay" : "timeGridWeek",
          headerToolbar: {
            left: "prev,next today",
            center: "title",
            right: isMobile
              ? "timeGridDay,listWeek"
              : "dayGridMonth,timeGridWeek,timeGridDay",
          },
          views: {
            listWeek: {
              type: "list",
              duration: { days: 7 },
              listDayFormat: {
                weekday: "short",
                month: "numeric",
                day: "numeric",
              },
            },
          },
          events: {
            url: "filtered_calendar.ics",
            format: "ics",
            extraParams: () => ({ cache: Date.now() }),
          },
          locale: "fr",
          firstDay: 1,
          slotMinTime: "08:00:00",
          slotMaxTime: "20:00:00",
          height: "auto",
          navLinks: true,
          nowIndicator: true,
          eventTimeFormat: {
            hour: "2-digit",
            minute: "2-digit",
            meridiem: false,
          },
          eventDidMount: function (info) {
            // Ajout du titre au survol pour les √©v√©nements tronqu√©s
            const eventEl = info.el;
            const eventMain = eventEl.querySelector(".fc-event-main");

            // Titre comme infobulle compl√®te
            eventEl.title = info.event.title;

            const description = info.event.extendedProps.description || "";
            const salleMatch = description.match(/Salle : (.+)/);

            if (salleMatch && salleMatch[1]) {
              const salleText = salleMatch[1].trim();
              const salleElement = document.createElement("div");
              salleElement.className = "event-location";
              salleElement.innerHTML = `üè´ ${salleText}`;

              // Ajouter la salle √† l'√©l√©ment d'√©v√©nement
              eventMain.appendChild(salleElement);

              // Ajouter aussi la salle √† l'infobulle
              eventEl.title += ` | Salle: ${salleText}`;
            }
          },
        });

        calendar.render();

        // Rafra√Æchissement automatique lors du redimensionnement
        window.addEventListener("resize", () => {
          calendar.changeView(isMobile ? "timeGridDay" : "timeGridWeek");
        });
      });
    </script>
  </body>
</html>
